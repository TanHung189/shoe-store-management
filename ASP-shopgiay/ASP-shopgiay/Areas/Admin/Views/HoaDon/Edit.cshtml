@model ASP_shopgiay.Models.Hoadon

@{
    ViewData["Title"] = "Chỉnh Sửa Đơn Hàng";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-invoice me-2"></i>Chỉnh Sửa Đơn Hàng #@Model.MaHd</h2>
    <a asp-action="Details" asp-route-id="@Model.MaHd" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Quay Lại
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <form asp-action="Edit" method="post" class="needs-validation" novalidate>
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                    <input type="hidden" asp-for="MaHd" />
                    <input type="hidden" asp-for="MaTk" />

                    <!-- Thông tin cơ bản (chỉ đọc) -->
                    <h5 class="mb-3">Thông Tin Cơ Bản</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Mã Đơn</strong></label>
                            <input type="text" class="form-control" value="@Model.MaHd" disabled />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Ngày Đặt</strong></label>
                            <input type="text" class="form-control" value="@Model.Ngay?.ToString("dd/MM/yyyy HH:mm")" disabled />
                        </div>
                    </div>

                    <!-- Thông tin khách hàng (chỉ đọc) -->
                    <h5 class="mb-3">Khách Hàng</h5>
                    <div class="mb-3">
                        <label class="form-label"><strong>Tên Khách Hàng</strong></label>
                        <input type="text" class="form-control" value="@Model.MaTkNavigation?.Ten" disabled />
                    </div>

                    <!-- Thông tin giao hàng -->
                    <h5 class="mb-3">Thông Tin Giao Hàng</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="TenNguoiNhan" class="form-label"><strong>Tên Người Nhận</strong></label>
                            <input asp-for="TenNguoiNhan" class="form-control" required />
                            <span asp-validation-for="TenNguoiNhan" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="DienThoaiGiaoHang" class="form-label"><strong>Điện Thoại</strong></label>
                            <input asp-for="DienThoaiGiaoHang" class="form-control" required />
                            <span asp-validation-for="DienThoaiGiaoHang" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="DiaChiGiaoHang" class="form-label"><strong>Địa Chỉ Giao Hàng</strong></label>
                        <input asp-for="DiaChiGiaoHang" class="form-control" required />
                        <span asp-validation-for="DiaChiGiaoHang" class="text-danger"></span>
                    </div>

                    <!-- Thanh toán & Trạng thái -->
                    <h5 class="mb-3">Phương Thức & Trạng Thái</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="MaPt" class="form-label"><strong>Phương Thức Thanh Toán</strong></label>
                            <select asp-for="MaPt" class="form-select" asp-items="ViewBag.MaPt" required>
                                <option value="">-- Chọn phương thức --</option>
                            </select>
                            <span asp-validation-for="MaPt" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="MaTrangThai" class="form-label"><strong>Trạng Thái Đơn</strong></label>
                            <select asp-for="MaTrangThai" class="form-select" asp-items="ViewBag.MaTrangThai" required>
                                <option value="">-- Chọn trạng thái --</option>
                            </select>
                            <span asp-validation-for="MaTrangThai" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Chi phí -->
                    <h5 class="mb-3">Chi Phí</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label asp-for="TamTinh" class="form-label"><strong>Tạm Tính</strong></label>
                            <div class="input-group">
                                <input asp-for="TamTinh" class="form-control" type="number" step="0.01" id="TamTinh" />
                                <span class="input-group-text">₫</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="PhiVanChuyen" class="form-label"><strong>Phí Vận Chuyển</strong></label>
                            <div class="input-group">
                                <input asp-for="PhiVanChuyen" class="form-control" type="number" step="0.01" id="PhiVanChuyen" />
                                <span class="input-group-text">₫</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="GiamGia" class="form-label"><strong>Giảm Giá</strong></label>
                            <div class="input-group">
                                <input asp-for="GiamGia" class="form-control" type="number" step="0.01" id="GiamGia" />
                                <span class="input-group-text">₫</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="MaGiamGia" class="form-label"><strong>Mã Giảm Giá (Tùy Chọn)</strong></label>
                        <select asp-for="MaGiamGia" class="form-select" asp-items="ViewBag.MaGiamGia">
                            <option value="">-- Không có --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label asp-for="TongTien" class="form-label"><strong>Tổng Tiền</strong></label>
                        <div class="input-group">
                            <input asp-for="TongTien" class="form-control" type="number" step="0.01" id="TongTien" readonly />
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu Thay Đổi
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.MaHd" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quản lý Chi tiết Hóa Đơn -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Thêm Sản Phẩm</h5>
            </div>
            <div class="card-body">
                <!-- Chọn sản phẩm từ combobox -->
                <div class="mb-3">
                    <label class="form-label"><strong>Chọn Sản Phẩm</strong></label>
                    <select id="selectProduct" class="form-select">
                        <option value="">-- Chọn sản phẩm --</option>
                    </select>
                </div>

                <!-- Chi tiết sản phẩm được chọn -->
                <div id="selectedProductInfo" class="alert alert-info mb-3" style="display:none;">
                    <p class="mb-2"><strong>Sản Phẩm:</strong> <span id="selectedProductName"></span></p>
                    <p class="mb-2"><strong>Giá:</strong> <span id="selectedProductPrice">0</span> ₫</p>
                    <p class="mb-0"><strong>Tồn Kho:</strong> <span id="selectedProductStock">0</span></p>
                </div>

                <!-- Form thêm sản phẩm -->
                <div id="addProductForm" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label"><strong>Số Lượng</strong></label>
                        <input type="number" id="orderQuantity" class="form-control" min="1" value="1" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Đơn Giá</strong></label>
                        <div class="input-group">
                            <input type="number" id="orderPrice" class="form-control" step="0.01" />
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Giảm Giá CT (Tùy Chọn)</strong></label>
                        <div class="input-group">
                            <input type="number" id="orderDiscount" class="form-control" step="0.01" value="0" />
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success w-100" id="btnAddProduct">
                        <i class="fas fa-plus me-2"></i>Thêm Sản Phẩm
                    </button>
                </div>
            </div>
        </div>

        <!-- Danh sách sản phẩm trong đơn hàng -->
        <div class="card mt-3">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Danh Sách Sản Phẩm (<span id="productCount">0</span>)</h5>
            </div>
            <div class="card-body p-0">
                <div id="orderDetailsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Danh sách chi tiết hóa đơn sẽ được tải vào đây -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const maHd = @Model.MaHd;
        let allVariants = [];
        let selectedVariant = null;

        $(document).ready(function () {
            loadAllProductVariants();
            loadOrderDetails();
            setupProductSelection();
            setupAddProductButton();
            setupPriceCalculation();
        });

        // ============================================
        // 1. LOAD TẤT CẢ BIẾN THỂ SẢN PHẨM VÀO COMBOBOX
        // ============================================
        function loadAllProductVariants() {
            $.ajax({
                url: '@Url.Action("GetAllProductVariants", "HoaDon", new { area = "Admin" })',
                type: 'GET',
                success: function (data) {
                    allVariants = data;
                    const selectProduct = $('#selectProduct');
                    selectProduct.empty();
                    selectProduct.append('<option value="">-- Chọn sản phẩm --</option>');

                    data.forEach(item => {
                        selectProduct.append(`<option value="${item.maBienThe}">${item.displayText}</option>`);
                    });
                },
                error: function (err) {
                    console.error('Lỗi khi tải danh sách sản phẩm:', err);
                }
            });
        }

        // ============================================
        // 2. SETUP CHỌN SẢN PHẨM TỪ COMBOBOX
        // ============================================
        function setupProductSelection() {
            $('#selectProduct').on('change', function () {
                const maBienThe = $(this).val();

                if (!maBienThe) {
                    selectedVariant = null;
                    $('#selectedProductInfo').hide();
                    $('#addProductForm').hide();
                    return;
                }

                // Tìm thông tin sản phẩm từ danh sách đã tải
                selectedVariant = allVariants.find(v => v.maBienThe == maBienThe);

                if (selectedVariant) {
                    $('#selectedProductName').text(selectedVariant.displayText);
                    $('#selectedProductPrice').text(selectedVariant.giaBan.toLocaleString('vi-VN'));
                    $('#selectedProductStock').text(selectedVariant.soLuongTon);
                    $('#orderPrice').val(selectedVariant.giaBan);
                    $('#orderQuantity').val(1);
                    $('#orderDiscount').val(0);

                    $('#selectedProductInfo').show();
                    $('#addProductForm').show();
                } else {
                    $('#selectedProductInfo').hide();
                    $('#addProductForm').hide();
                }
            });
        }

        // ============================================
        // 3. THÊM SẢN PHẨM VÀO ĐƠN HÀNG
        // ============================================
        function setupAddProductButton() {
            $('#btnAddProduct').on('click', function () {
                if (!selectedVariant) {
                    alert('Vui lòng chọn sản phẩm');
                    return;
                }

                const soLuong = parseInt($('#orderQuantity').val());
                const donGia = parseFloat($('#orderPrice').val());
                const giamGiaCt = parseFloat($('#orderDiscount').val()) || 0;

                if (soLuong <= 0) {
                    alert('Số lượng phải lớn hơn 0');
                    return;
                }

                if (donGia < 0) {
                    alert('Giá không được âm');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("AddOrderDetail", "HoaDon", new { area = "Admin" })',
                    type: 'POST',
                    data: {
                        maHd: maHd,
                        maBienThe: selectedVariant.maBienThe,
                        soLuong: soLuong,
                        donGia: donGia,
                        giamGiaCt: giamGiaCt
                    },
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message);
                            loadOrderDetails();
                            calculateTotalPrice();
                            resetProductForm();
                        } else {
                            toastr.error('Lỗi: ' + response.message);
                        }
                    },
                    error: function (err) {
                        console.error('Lỗi:', err);
                        toastr.error('Có lỗi xảy ra khi thêm sản phẩm');
                    }
                });
            });
        }

        // ============================================
        // 4. RESET FORM SAU KHI THÊM
        // ============================================
        function resetProductForm() {
            $('#selectProduct').val('');
            selectedVariant = null;
            $('#selectedProductInfo').hide();
            $('#addProductForm').hide();
            $('#orderQuantity').val(1);
            $('#orderDiscount').val(0);
        }

        // ============================================
        // 5. LOAD DANH SÁCH CHI TIẾT HÓA ĐƠN
        // ============================================
        function loadOrderDetails() {
            $.ajax({
                url: '@Url.Action("GetOrderDetails", "HoaDon", new { area = "Admin" })',
                type: 'GET',
                data: { maHd: maHd },
                success: function (data) {
                    const list = $('#orderDetailsList');
                    list.empty();
                    $('#productCount').text(data.length);

                    if (data.length === 0) {
                        list.append('<div class="p-3 text-muted text-center">Chưa có sản phẩm</div>');
                        return;
                    }

                    let totalTamTinh = 0;
                    data.forEach(item => {
                        const thanhTien = item.soLuong * item.donGia - (item.giamGiaCt || 0);
                        totalTamTinh += thanhTien;

                        list.append(`
                            <div class="p-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${item.tenSanPham}</h6>
                                        <small class="text-muted">${item.tenMau} - Size ${item.tenKichThuoc}</small>
                                        <div class="mt-2">
                                            <small>
                                                <strong>SL:</strong> ${item.soLuong} x ${item.donGia.toLocaleString('vi-VN')} ₫
                                                ${item.giamGiaCt > 0 ? ` - ${item.giamGiaCt.toLocaleString('vi-VN')} ₫` : ''}
                                            </small>
                                        </div>
                                        <div class="mt-1">
                                            <strong style="color: #d9534f;">${thanhTien.toLocaleString('vi-VN')} ₫</strong>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary btn-edit" data-ma-cthd="${item.maCthd}" title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger btn-delete" data-ma-cthd="${item.maCthd}" title="Xóa">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `);
                    });

                    $('#TamTinh').val(totalTamTinh);
                    calculateTotalPrice();
                },
                error: function (err) {
                    console.error('Lỗi khi tải chi tiết hóa đơn:', err);
                }
            });
        }

        // ============================================
        // 6. XÓA CHI TIẾT HÓA ĐƠN
        // ============================================
        $(document).on('click', '.btn-delete', function () {
            const maCthd = $(this).data('ma-cthd');
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                $.ajax({
                    url: '@Url.Action("DeleteOrderDetail", "HoaDon", new { area = "Admin" })',
                    type: 'POST',
                    data: { maCthd: maCthd },
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message);
                            loadOrderDetails();
                            calculateTotalPrice();
                        } else {
                            toastr.error('Lỗi: ' + response.message);
                        }
                    }
                });
            }
        });

        // ============================================
        // 7. TÍNH TỔNG TIỀN TỰ ĐỘNG
        // ============================================
        function setupPriceCalculation() {
            $('#PhiVanChuyen, #GiamGia').on('input', calculateTotalPrice);
        }

        function calculateTotalPrice() {
            const tamTinh = parseFloat($('#TamTinh').val()) || 0;
            const phiVanChuyen = parseFloat($('#PhiVanChuyen').val()) || 0;
            const giamGia = parseFloat($('#GiamGia').val()) || 0;

            const tongTien = tamTinh + phiVanChuyen - giamGia;
            $('#TongTien').val(tongTien < 0 ? 0 : tongTien);
        }
    </script>

    <!-- Toastr for notifications (optional but recommended) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}