@model ASP_shopgiay.ViewModels.CartViewModel

@{
    ViewData["Title"] = "Giỏ Hàng";
    Layout = "_Layout";
}

<style>
    /* Ẩn nút tăng giảm mặc định của input number */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
</style>

<div class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4">

        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-shopping-cart text-indigo-600"></i>
                Giỏ Hàng <span class="text-sm font-normal text-gray-500 ml-2">(@Model.Items.Sum(i => i.SoLuong) sản phẩm)</span>
            </h1>
            <a href="@Url.Action("List", "Product")" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1 transition">
                <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
            </a>
        </div>

        <!-- Thông báo (Alerts) -->
        @if (TempData["Success"] != null)
        {
            <div class="mb-6 bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg shadow-sm flex items-center gap-3 animate-fade-in">
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                <p class="text-green-800 font-medium">@TempData["Success"]</p>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg shadow-sm flex items-center gap-3 animate-fade-in">
                <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                <p class="text-red-800 font-medium">@TempData["Error"]</p>
            </div>
        }

        @if (Model.Items.Any())
        {
            <div class="flex flex-col lg:flex-row gap-8">

                <!-- LEFT COLUMN: CART ITEMS -->
                <div class="lg:w-3/4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

                        <!-- Desktop Header -->
                        <div class="hidden md:grid grid-cols-12 gap-4 bg-gray-50/50 px-6 py-4 border-b border-gray-100 text-xs font-bold text-gray-500 uppercase tracking-wider">
                            <div class="col-span-6">Thông tin sản phẩm</div>
                            <div class="col-span-2 text-center">Đơn giá</div>
                            <div class="col-span-2 text-center">Số lượng</div>
                            <div class="col-span-2 text-right">Thành tiền</div>
                        </div>

                        <!-- List Items -->
                        <div class="divide-y divide-gray-100">
                            @foreach (var item in Model.Items)
                            {
                                <div class="p-6 hover:bg-gray-50/50 transition duration-200">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">

                                        <!-- 1. Info (Ảnh + Tên) -->
                                        <div class="md:col-span-6 flex gap-5">
                                            <!-- Xử lý ảnh thông minh -->
                                            <div class="w-24 h-24 flex-shrink-0 bg-white rounded-xl border border-gray-200 overflow-hidden relative group">
                                                @{
                                                    string imgUrl = item.HinhAnh;
                                                    if (!string.IsNullOrEmpty(imgUrl) && !imgUrl.StartsWith("http") && !imgUrl.StartsWith("/"))
                                                    {
                                                        imgUrl = $"/images/products/{imgUrl}";
                                                    }
                                                }
                                                <img src="@imgUrl"
                                                     alt="@item.TenSanpham"
                                                     class="w-full h-full object-cover object-center group-hover:scale-110 transition duration-500"
                                                     onerror="this.onerror=null; this.src='https://placehold.co/150x150/f3f4f6/9ca3af?text=No+Image';">
                                            </div>

                                            <div class="flex flex-col justify-center">
                                                <div class="text-xs font-bold text-indigo-500 uppercase tracking-wide mb-1">@item.TenThuongHieu</div>
                                                <a href="@Url.Action("Detail", "Product", new { productId = item.MaBienThe })"
                                                   class="text-base font-bold text-gray-900 hover:text-indigo-600 transition line-clamp-1 mb-1">
                                                    @item.TenSanpham
                                                </a>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
                                                        Màu: @item.TenMau
                                                    </span>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
                                                        Size: @item.TenKichThuoc
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 2. Đơn giá -->
                                        <div class="hidden md:block md:col-span-2 text-center">
                                            <span class="text-sm font-medium text-gray-600">@item.DonGia.ToString("N0")₫</span>
                                        </div>

                                        <!-- 3. Bộ điều khiển số lượng (+/-) -->
                                        <div class="md:col-span-2 flex justify-center">
                                            <form asp-action="UpdateCart" method="post" id="form-update-@item.MaGioHang" class="flex items-center">
                                                <input type="hidden" name="maGioHang" value="@item.MaGioHang" />

                                                <div class="flex items-center border border-gray-300 rounded-lg bg-white overflow-hidden shadow-sm w-28">
                                                    <!-- Nút Trừ -->
                                                    <button type="button" onclick="updateQuantity(@item.MaGioHang, -1)"
                                                            class="w-8 h-9 flex items-center justify-center bg-white hover:bg-gray-100 border-r border-gray-200 transition text-gray-600">
                                                        <i class="fas fa-minus text-xs"></i>
                                                    </button>

                                                    <!-- Input -->
                                                    <input type="number" id="qty-@item.MaGioHang" name="soLuongMoi"
                                                           value="@item.SoLuong" min="1" max="@item.SoLuongTon"
                                                           class="w-full h-9 text-center border-none focus:ring-0 text-sm font-semibold text-gray-800 p-0"
                                                           readonly />

                                                    <!-- Nút Cộng -->
                                                    <button type="button" onclick="updateQuantity(@item.MaGioHang, 1)"
                                                            class="w-8 h-9 flex items-center justify-center bg-white hover:bg-gray-100 border-l border-gray-200 transition text-gray-600"
                                                            @(item.SoLuong >= item.SoLuongTon ? "disabled" : "")>
                                                        <i class="fas fa-plus text-xs"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- 4. Thành tiền & Xóa -->
                                        <div class="md:col-span-2 text-right flex flex-col items-end justify-center gap-3">
                                            <span class="text-indigo-600 font-bold text-lg">@item.ThanhTien.ToString("N0")₫</span>

                                            <form asp-action="RemoveFromCart" method="post">
                                                <input type="hidden" name="maGioHang" value="@item.MaGioHang" />
                                                <button type="submit" class="text-gray-400 hover:text-red-500 transition text-sm flex items-center gap-1 group" title="Xóa">
                                                    <i class="far fa-trash-alt group-hover:scale-110 transition-transform"></i>
                                                    <span class="md:hidden">Xóa</span>
                                                </button>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: SUMMARY -->
                <div class="lg:w-1/4">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24">
                        <h2 class="text-lg font-bold text-gray-900 mb-6 pb-4 border-b border-gray-100">
                            Tổng đơn hàng
                        </h2>

                        <div class="space-y-4 mb-6">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Tạm tính</span>
                                <span class="font-medium text-gray-900">@Model.TamTinh.ToString("N0")₫</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Giảm giá</span>
                                <span class="font-medium text-green-600">0₫</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Vận chuyển</span>
                                <span class="text-xs text-indigo-500 bg-indigo-50 px-2 py-1 rounded-full">Miễn phí</span>
                            </div>

                            <div class="pt-4 border-t border-gray-100 flex justify-between items-end">
                                <span class="text-base font-bold text-gray-900">Tổng cộng</span>
                                <div class="text-right">
                                    <span class="block text-2xl font-black text-indigo-600">@Model.TamTinh.ToString("N0")₫</span>
                                    <span class="text-[10px] text-gray-400 font-normal">(Đã bao gồm VAT)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Nút Thanh Toán -->
                        <a href="@Url.Action("Checkout", "Order")" class="block w-full bg-indigo-600 text-white text-center font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 hover:shadow-indigo-200 hover:-translate-y-0.5 transition-all duration-300">
                            THANH TOÁN NGAY
                        </a>

                        <!-- Payment Icons -->
                        <div class="mt-8 pt-6 border-t border-gray-100">
                            <p class="text-xs text-center text-gray-400 mb-3">Chúng tôi chấp nhận</p>
                            <div class="flex justify-center gap-3 opacity-60 grayscale hover:grayscale-0 transition-all duration-500">
                                <i class="fab fa-cc-visa text-2xl text-blue-900"></i>
                                <i class="fab fa-cc-mastercard text-2xl text-red-600"></i>
                                <i class="fab fa-cc-paypal text-2xl text-blue-700"></i>
                                <i class="fas fa-money-bill-wave text-2xl text-green-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- TRẠNG THÁI GIỎ HÀNG TRỐNG -->
            <div class="max-w-2xl mx-auto text-center py-16">
                <div class="w-48 h-48 bg-white rounded-full flex items-center justify-center mx-auto mb-8 shadow-sm">
                    <img src="https://cdn-icons-png.flaticon.com/512/11329/11329060.png" alt="Empty Cart" class="w-24 h-24 opacity-50 grayscale">
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-3">Giỏ hàng của bạn đang trống</h2>
                <p class="text-gray-500 mb-8">Có vẻ như bạn chưa thêm sản phẩm nào. Hãy khám phá bộ sưu tập mới nhất của chúng tôi nhé!</p>
                <a href="@Url.Action("List", "Product")" class="inline-flex items-center gap-2 bg-indigo-600 text-white font-bold py-3.5 px-8 rounded-full shadow-lg hover:bg-indigo-700 hover:shadow-indigo-200 transition transform hover:-translate-y-1">
                    <i class="fas fa-shopping-bag"></i> Mua Sắm Ngay
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Hàm xử lý tăng giảm số lượng
        function updateQuantity(itemId, change) {
            const input = document.getElementById(`qty-${itemId}`);
            let currentValue = parseInt(input.value);
            const maxStock = parseInt(input.max);
            const newValue = currentValue + change;

            // Validate
            if (newValue >= 1 && newValue <= maxStock) {
                input.value = newValue;
                // Submit form tự động
                document.getElementById(`form-update-${itemId}`).submit();
            } else if (newValue > maxStock) {
                alert(`Xin lỗi, chỉ còn ${maxStock} sản phẩm trong kho.`);
            }
        }
    </script>
}