@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject ASP_shopgiay.Data.ApplicationDbContext Context // Tiêm DbContext để lấy Danh mục
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor // Tiêm để truy cập Session/User

@{
    // Dữ liệu chung cho Menu (Lấy Danh mục cha)
    // LƯU Ý: Đây là cách tạm thời để hiển thị menu trong Layout.
    // Trong thực tế, nên dùng View Component hoặc Dependency Injection khác để tránh truy vấn đồng bộ.
    var danhMucCha = Context.Danhmucs!
        .Where(dm => dm.ParentId == null && dm.TrangThai == true)
        .OrderBy(dm => dm.ThuTu)
        .ToList();

    // Lấy tên người dùng đang đăng nhập
    var userName = HttpContextAccessor.HttpContext?.User.FindFirst(ClaimTypes.Name)?.Value;
    // Giả định MaTK được lưu trong Claims khi đăng nhập
    var maTk = HttpContextAccessor.HttpContext?.User.FindFirst("MaTK")?.Value;

    // Giỏ hàng count (Giả định lấy số lượng mục trong giỏ)
    int cartCount = 0;
    if (!string.IsNullOrEmpty(maTk) && int.TryParse(maTk, out int userId))
    {
        // Thực hiện truy vấn để lấy số lượng item trong giỏ hàng của user này
        // Lưu ý: Cần đảm bảo DbSet Giohangs có sẵn trong DbContext
        cartCount = Context.Giohangs!.Count(gh => gh.MaTk == userId);
    }
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - ShopGiay</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter & Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Styling chung -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }

        .container {
            max-width: 1200px;
        }
    </style>
</head>
<body>

    <!-- ============================================= -->
    <!-- HEADER (Menu và Auth) -->
    <!-- ============================================= -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-black text-indigo-700 hover:text-indigo-900 transition">SHOPGIAY</a>

            <!-- Menu Danh mục Cha (Sử dụng dữ liệu từ DbContext) -->
            <nav class="hidden md:flex space-x-6">
                @foreach (var dm in danhMucCha)
                {
                    <a href="@Url.Action("List", "Product", new { categoryId = dm.MaDm })"
                       class="text-gray-700 font-semibold hover:text-indigo-600 transition duration-150">
                        @dm.Ten
                    </a>
                }
            </nav>

            <!-- Khu vực Giỏ hàng và Đăng nhập/Đăng xuất -->
            <div class="flex space-x-4 items-center">
                <!-- Nút Giỏ hàng -->
                <a href="@Url.Action("Index", "Cart")" class="text-gray-700 hover:text-indigo-600 p-2 rounded-full hover:bg-gray-100 transition relative">
                    <i class="fas fa-shopping-cart text-lg"></i>
                    <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">@cartCount</span>
                </a>

                @if (User.Identity!.IsAuthenticated)
                {
                    <!-- ĐÃ ĐĂNG NHẬP -->
                    <div class="flex items-center space-x-2 group relative">
                        <span class="text-sm font-semibold text-gray-700 cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                            <i class="fas fa-user-circle mr-1"></i> @userName!
                        </span>

                        <!-- Dropdown menu -->
                        <div class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl overflow-hidden z-30 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition duration-200 pointer-events-none group-hover:pointer-events-auto">
                            <a href="@Url.Action("Profile", "Account")" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                                Hồ sơ
                            </a>
                            <a href="@Url.Action("History", "Order")" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                                Lịch sử mua hàng
                            </a>
                            <form asp-controller="Account" asp-action="Logout" method="post" class="border-t border-gray-100">
                                <button type="submit" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                    <i class="fas fa-sign-out-alt mr-1"></i> Đăng xuất
                                </button>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <!-- CHƯA ĐĂNG NHẬP -->
                    <a href="@Url.Action("Login", "Account")"
                       class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">
                        Đăng nhập
                    </a>
                    <a href="@Url.Action("Register", "Account")"
                       class="text-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-100 transition font-semibold text-sm border border-indigo-600 hidden sm:inline-block">
                        Đăng ký
                    </a>
                }
            </div>
        </div>
    </header>

    <!-- ============================================= -->
    <!-- MAIN CONTENT (Nơi nội dung View cụ thể được render) -->
    <!-- ============================================= -->
    <main role="main" class="pb-3">
        @RenderBody()
    </main>

    <!-- ============================================= -->
    <!-- FOOTER -->
    <!-- ============================================= -->
    <footer class="bg-gray-800 text-white mt-12 border-t border-gray-700">
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Cột 1: Giới thiệu -->
                <div>
                    <h5 class="text-xl font-bold mb-4 text-indigo-400">SHOPGIAY</h5>
                    <p class="text-sm text-gray-400">Chuyên cung cấp các loại giày sneaker chính hãng với chất lượng tốt nhất.</p>
                </div>
                <!-- Cột 2: Danh mục -->
                <div>
                    <h5 class="text-lg font-semibold mb-4 text-indigo-400">Danh Mục</h5>
                    <ul class="space-y-2 text-sm">
                        @foreach (var dm in danhMucCha)
                        {
                            <li><a href="@Url.Action("List", "Product", new { categoryId = dm.MaDm })" class="text-gray-400 hover:text-white transition">@dm.Ten</a></li>
                        }
                    </ul>
                </div>
                <!-- Cột 3: Hỗ trợ -->
                <div>
                    <h5 class="text-lg font-semibold mb-4 text-indigo-400">Hỗ Trợ</h5>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#" class="hover:text-white transition">Chính sách đổi trả</a></li>
                        <li><a href="#" class="hover:text-white transition">Chính sách bảo mật</a></li>
                        <li><a href="#" class="hover:text-white transition">Câu hỏi thường gặp</a></li>
                    </ul>
                </div>
                <!-- Cột 4: Liên hệ -->
                <div>
                    <h5 class="text-lg font-semibold mb-4 text-indigo-400">Liên Hệ</h5>
                    <p class="text-sm text-gray-400">Email: support@shopgiay.vn</p>
                    <p class="text-sm text-gray-400">Điện thoại: 090-XXX-XXXX</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-900 py-3 text-center text-sm text-gray-500">
            <p>&copy; @DateTime.Now.Year ShopGiay. All rights reserved.</p>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Render Section Scripts nếu View con có yêu cầu -->
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>